<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>üìö Question Bank ‚Äì Bulk Import & Timed Tests</title>
    <style>
        * { box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
        body { background: #0f172a; margin: 0; padding: 16px; display: flex; justify-content: center; min-height: 100vh; }
        .app { max-width: 750px; width: 100%; background: white; padding: 24px; border-radius: 32px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        h1 { font-size: 1.8rem; margin-top: 0; color: #0f172a; display: flex; align-items: center; gap: 8px; }
        h2 { font-size: 1.3rem; color: #334155; margin: 20px 0 12px; }
        .badge { background: #3b82f6; color: white; padding: 4px 12px; border-radius: 100px; font-size: 0.8rem; font-weight: 600; }
        
        /* Mode tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; background: #f1f5f9; padding: 6px; border-radius: 100px; }
        .tab { flex: 1; padding: 12px; border: none; border-radius: 100px; background: transparent; font-weight: 600; color: #475569; }
        .tab.active { background: white; color: #0f172a; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }

        /* Cards */
        .card { background: #f8fafc; padding: 20px; border-radius: 24px; margin-bottom: 24px; }
        .stat-card { background: linear-gradient(145deg, #f8fafc, #ffffff); padding: 16px; border-radius: 20px; border: 1px solid #e2e8f0; }
        
        /* Import area */
        .import-area { background: #ffffff; border: 2px dashed #94a3b8; border-radius: 20px; padding: 24px; text-align: center; }
        textarea, input { width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 16px; font-size: 1rem; margin-bottom: 12px; }
        
        /* Buttons */
        .btn { background: #3b82f6; color: white; border: none; padding: 14px 24px; border-radius: 40px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 8px; }
        .btn-success { background: #10b981; }
        .btn-warning { background: #f59e0b; }
        .btn-outline { background: transparent; border: 2px solid #3b82f6; color: #3b82f6; }
        
        /* Timer */
        .timer { background: #1e293b; color: white; padding: 16px 24px; border-radius: 100px; display: flex; justify-content: space-between; align-items: center; font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; }
        .timer-warning { background: #b91c1c; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } }
        
        /* Question */
        .question-card { background: white; border: 2px solid #e2e8f0; border-radius: 24px; padding: 24px; margin-bottom: 20px; }
        .question-text { font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; color: #0f172a; }
        .choice { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; }
        .choice.selected { background: #dbeafe; border-color: #3b82f6; }
        
        .hidden { display: none; }
        .text-sm { font-size: 0.9rem; color: #64748b; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    </style>
</head>
<body>
<div class="app">
    <h1>üìö Question Bank Pro</h1>
    <p class="text-sm">Import questions once ‚Üí Take timed tests anytime</p>

    <!-- Tabs -->
    <div class="tabs">
        <button id="tabBank" class="tab active">üì¶ Bank</button>
        <button id="tabImport" class="tab">üì§ Import</button>
        <button id="tabTest" class="tab">‚è±Ô∏è Test</button>
    </div>

    <!-- ============ BANK VIEW ============ -->
    <div id="bankView">
        <div class="stat-card" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span class="badge">üìä BANK STATUS</span>
                <h2 style="margin: 8px 0 0; font-size: 2rem;" id="bankCount">0</h2>
                <span class="text-sm">total questions in bank</span>
            </div>
            <button id="clearBankBtn" class="btn-outline" style="width: auto; padding: 10px 20px;">üóëÔ∏è Clear</button>
        </div>

        <div class="card">
            <h2>‚öôÔ∏è Start New Test</h2>
            <div style="margin: 20px 0;">
                <label>üìã Number of questions:</label>
                <select id="testQuestionCount" style="width: 100%; padding: 16px; border-radius: 16px; margin: 8px 0 16px; border: 2px solid #e2e8f0;">
                    <option value="20">20 questions</option>
                    <option value="30" selected>30 questions</option>
                    <option value="40">40 questions</option>
                    <option value="50">50 questions</option>
                    <option value="60">60 questions</option>
                </select>
                
                <label>‚è≤Ô∏è Time limit:</label>
                <select id="testTimeLimit" style="width: 100%; padding: 16px; border-radius: 16px; margin: 8px 0 16px; border: 2px solid #e2e8f0;">
                    <option value="10">10 minutes</option>
                    <option value="20">20 minutes</option>
                    <option value="30" selected>30 minutes</option>
                    <option value="45">45 minutes</option>
                    <option value="60">60 minutes</option>
                </select>
                
                <button id="startTestBtn" class="btn-success" style="font-size: 1.2rem; padding: 18px;">üöÄ START TEST</button>
            </div>
        </div>

        <div class="card">
            <h2>üìñ Sample Questions (first 5)</h2>
            <div id="sampleQuestions"></div>
        </div>
    </div>

    <!-- ============ IMPORT VIEW ============ -->
    <div id="importView" class="hidden">
        <div class="card">
            <h2>üì• Bulk Import Questions</h2>
            <div class="import-area">
                <p style="font-weight: 600;">Format: Question | Choice A | Choice B | Choice C | Choice D | Correct Letter</p>
                <p class="text-sm">Correct letter: A, B, C, or D</p>
                
                <textarea id="importText" rows="8" placeholder="Paste your questions here...&#10;&#10;Example:&#10;What is the capital of France? | Paris | London | Berlin | Madrid | A&#10;What is 2+2? | 3 | 4 | 5 | 6 | B&#10;Which planet is closest to the sun? | Venus | Earth | Mercury | Mars | C">What is the capital of France? | Paris | London | Berlin | Madrid | A
What is 2+2? | 3 | 4 | 5 | 6 | B
Which planet is closest to the sun? | Venus | Earth | Mercury | Mars | C
What is the largest ocean? | Atlantic | Indian | Arctic | Pacific | D
Who wrote Romeo and Juliet? | Dickens | Shakespeare | Austen | Hemingway | B</textarea>
                
                <div class="grid-2" style="margin-top: 16px;">
                    <button id="importCsvBtn" class="btn">üìã Import from text</button>
                    <button id="importJsonBtn" class="btn-outline">üìÅ Import JSON file</button>
                </div>
                <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                
                <p class="text-sm" style="margin-top: 20px;">‚úÖ Questions are saved permanently to your bank</p>
            </div>
        </div>
    </div>

    <!-- ============ TEST VIEW ============ -->
    <div id="testView" class="hidden">
        <div id="timerDisplay" class="timer">
            <span>‚è±Ô∏è Time remaining</span>
            <span id="timeRemaining">30:00</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
            <span class="badge" id="progressIndicator">1 / 30</span>
            <span class="badge" style="background: #8b5cf6;" id="answeredCount">0 answered</span>
        </div>

        <div id="testQuestionsContainer"></div>

        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button id="testPrevBtn" class="btn-outline" style="flex: 1;" disabled>‚óÄ Previous</button>
            <button id="testNextBtn" class="btn-outline" style="flex: 1;">Next ‚ñ∂</button>
        </div>
        
        <button id="submitTestBtn" class="btn-success" style="margin-top: 24px; font-size: 1.2rem; display: none;">‚úÖ Submit Test</button>
        
        <div id="testScoreCard" class="card" style="display: none; text-align: center;">
            <h2 style="color: #10b981;">üéâ Test Complete!</h2>
            <div style="font-size: 3rem; font-weight: 800;" id="finalScore">0%</div>
            <div style="font-size: 1.2rem;" id="finalScoreDetails">0/0 correct</div>
            <button id="backToBankBtn" class="btn" style="margin-top: 20px;">üì¶ Back to Bank</button>
        </div>
    </div>
</div>

<script>
    // ---------- QUESTION BANK (localStorage) ----------
    let questionBank = [];  // Permanent storage
    const BANK_KEY = 'proQuestionBank';
    
    // Test state
    let currentTestQuestions = [];
    let userAnswers = [];
    let currentIndex = 0;
    let timerInterval = null;
    let timeLeft = 0;
    let testTimeLimit = 30; // minutes

    // ---------- LOAD / SAVE BANK ----------
    function loadBank() {
        const stored = localStorage.getItem(BANK_KEY);
        if (stored) {
            try {
                questionBank = JSON.parse(stored);
            } catch (e) {
                questionBank = [];
            }
        }
        
        // Add default questions if bank empty
        if (questionBank.length === 0) {
            questionBank = [
                { text: "What is the capital of France?", choices: ["Paris", "London", "Berlin", "Madrid"], correct: 0 },
                { text: "What is 2+2?", choices: ["3", "4", "5", "6"], correct: 1 },
                { text: "Which planet is closest to the sun?", choices: ["Venus", "Earth", "Mercury", "Mars"], correct: 2 },
                { text: "What is the largest ocean?", choices: ["Atlantic", "Indian", "Arctic", "Pacific"], correct: 3 },
                { text: "Who wrote Romeo and Juliet?", choices: ["Dickens", "Shakespeare", "Austen", "Hemingway"], correct: 1 }
            ];
            saveBank();
        }
        
        updateBankUI();
    }
    
    function saveBank() {
        localStorage.setItem(BANK_KEY, JSON.stringify(questionBank));
        updateBankUI();
    }
    
    function updateBankUI() {
        document.getElementById('bankCount').innerText = questionBank.length;
        
        // Show sample (first 5)
        const sampleDiv = document.getElementById('sampleQuestions');
        sampleDiv.innerHTML = '';
        
        const samples = questionBank.slice(0, 5);
        if (samples.length === 0) {
            sampleDiv.innerHTML = '<p class="text-sm">No questions in bank. Import some!</p>';
            return;
        }
        
        samples.forEach((q, idx) => {
            sampleDiv.innerHTML += `
                <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                    <strong>Q${idx+1}:</strong> ${escapeHtml(q.text)}<br>
                    <span class="text-sm">‚úì ${escapeHtml(q.choices[q.correct])}</span>
                </div>
            `;
        });
    }

    // ---------- IMPORT ----------
    function importFromCsv(text) {
        const lines = text.trim().split('\n');
        let imported = 0;
        
        lines.forEach(line => {
            line = line.trim();
            if (line.length === 0) return;
            
            const parts = line.split('|').map(p => p.trim());
            if (parts.length >= 6) {
                const question = parts[0];
                const choices = [parts[1], parts[2], parts[3], parts[4]];
                const correctLetter = parts[5].toUpperCase();
                let correctIndex = 0;
                
                if (correctLetter === 'A') correctIndex = 0;
                else if (correctLetter === 'B') correctIndex = 1;
                else if (correctLetter === 'C') correctIndex = 2;
                else if (correctLetter === 'D') correctIndex = 3;
                
                questionBank.push({
                    text: question,
                    choices: choices,
                    correct: correctIndex
                });
                imported++;
            }
        });
        
        if (imported > 0) {
            saveBank();
            alert(`‚úÖ Successfully imported ${imported} questions!`);
        } else {
            alert('‚ùå No valid questions found. Check format: Question | A | B | C | D | CorrectLetter');
        }
    }

    // ---------- START TEST ----------
    function startTest() {
        if (questionBank.length < 20) {
            alert(`‚ö†Ô∏è Bank only has ${questionBank.length} questions. Import at least 20 for a proper test.`);
            return;
        }
        
        // Get settings
        const qCount = parseInt(document.getElementById('testQuestionCount').value);
        testTimeLimit = parseInt(document.getElementById('testTimeLimit').value);
        
        // Randomly select questions from bank
        const shuffled = [...questionBank].sort(() => Math.random() - 0.5);
        currentTestQuestions = shuffled.slice(0, Math.min(qCount, questionBank.length));
        
        userAnswers = new Array(currentTestQuestions.length).fill(-1);
        currentIndex = 0;
        
        // Switch to test view
        document.getElementById('bankView').classList.add('hidden');
        document.getElementById('importView').classList.add('hidden');
        document.getElementById('testView').classList.remove('hidden');
        document.getElementById('testScoreCard').style.display = 'none';
        document.getElementById('submitTestBtn').style.display = 'none';
        
        // Start timer
        startTimer(testTimeLimit * 60);
        
        renderTestQuestion();
    }

    // ---------- TIMER ----------
    function startTimer(seconds) {
        timeLeft = seconds;
        updateTimerDisplay();
        
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitTest();
            }
        }, 1000);
    }
    
    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timeRemaining').innerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Warning class
        const timerEl = document.getElementById('timerDisplay');
        if (timeLeft < 300) { // 5 minutes
            timerEl.classList.add('timer-warning');
        } else {
            timerEl.classList.remove('timer-warning');
        }
    }

    // ---------- RENDER TEST ----------
    function renderTestQuestion() {
        if (currentTestQuestions.length === 0) return;
        
        const q = currentTestQuestions[currentIndex];
        const container = document.getElementById('testQuestionsContainer');
        
        // Progress
        document.getElementById('progressIndicator').innerText = `${currentIndex + 1} / ${currentTestQuestions.length}`;
        const answered = userAnswers.filter(a => a !== -1).length;
        document.getElementById('answeredCount').innerText = `${answered} answered`;
        
        let html = `<div class="question-card">`;
        html += `<div class="question-text">${escapeHtml(q.text)}</div>`;
        
        q.choices.forEach((choice, idx) => {
            const isSelected = userAnswers[currentIndex] === idx;
            html += `
                <div class="choice ${isSelected ? 'selected' : ''}" onclick="selectAnswer(${currentIndex}, ${idx})">
                    <span style="font-weight: 700; margin-right: 12px;">${String.fromCharCode(65 + idx)}.</span>
                    ${escapeHtml(choice)}
                </div>
            `;
        });
        
        html += `</div>`;
        container.innerHTML = html;
        
        // Navigation buttons
        document.getElementById('testPrevBtn').disabled = currentIndex === 0;
        document.getElementById('testNextBtn').disabled = currentIndex === currentTestQuestions.length - 1;
        
        // Show submit on last question
        if (currentIndex === currentTestQuestions.length - 1) {
            document.getElementById('submitTestBtn').style.display = 'block';
        } else {
            document.getElementById('submitTestBtn').style.display = 'none';
        }
    }

    // Global function for onclick
    window.selectAnswer = function(qIdx, choiceIdx) {
        userAnswers[qIdx] = choiceIdx;
        renderTestQuestion();
    };

    // ---------- SUBMIT TEST ----------
    function submitTest() {
        clearInterval(timerInterval);
        
        // Calculate score
        let correct = 0;
        currentTestQuestions.forEach((q, idx) => {
            if (userAnswers[idx] === q.correct) correct++;
        });
        
        const percent = (correct / currentTestQuestions.length * 100).toFixed(1);
        
        // Show score
        document.getElementById('finalScore').innerText = `${percent}%`;
        document.getElementById('finalScoreDetails').innerText = `${correct}/${currentTestQuestions.length} correct`;
        document.getElementById('testScoreCard').style.display = 'block';
        document.getElementById('submitTestBtn').style.display = 'none';
        document.getElementById('testQuestionsContainer').innerHTML = '';
    }

    // ---------- UTILS ----------
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ---------- EVENT LISTENERS ----------
    window.onload = function() {
        loadBank();
        
        // Tab switching
        const tabBank = document.getElementById('tabBank');
        const tabImport = document.getElementById('tabImport');
        const tabTest = document.getElementById('tabTest');
        const bankView = document.getElementById('bankView');
        const importView = document.getElementById('importView');
        const testView = document.getElementById('testView');
        
        tabBank.addEventListener('click', () => {
            tabBank.classList.add('active');
            tabImport.classList.remove('active');
            tabTest.classList.remove('active');
            bankView.classList.remove('hidden');
            importView.classList.add('hidden');
            testView.classList.add('hidden');
            updateBankUI();
        });
        
        tabImport.addEventListener('click', () => {
            tabBank.classList.remove('active');
            tabImport.classList.add('active');
            tabTest.classList.remove('active');
            bankView.classList.add('hidden');
            importView.classList.remove('hidden');
            testView.classList.add('hidden');
        });
        
        tabTest.addEventListener('click', () => {
            if (testView.classList.contains('hidden')) {
                // Do nothing, test mode entered via Start button
            }
        });
        
        // Import
        document.getElementById('importCsvBtn').addEventListener('click', () => {
            const text = document.getElementById('importText').value;
            importFromCsv(text);
        });
        
        document.getElementById('importJsonBtn').addEventListener('click', () => {
            document.getElementById('jsonFileInput').click();
        });
        
        document.getElementById('jsonFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        if (Array.isArray(json)) {
                            questionBank.push(...json);
                            saveBank();
                            alert(`‚úÖ Imported ${json.length} questions from JSON!`);
                        }
                    } catch(err) {
                        alert('‚ùå Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            }
        });
        
        // Clear bank
        document.getElementById('clearBankBtn').addEventListener('click', () => {
            if (confirm('‚ö†Ô∏è Delete ALL questions from bank?')) {
                questionBank = [];
                saveBank();
            }
        });
        
        // Start test
        document.getElementById('startTestBtn').addEventListener('click', startTest);
        
        // Test navigation
        document.getElementById('testPrevBtn').addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                renderTestQuestion();
            }
        });
        
        document.getElementById('testNextBtn').addEventListener('click', () => {
            if (currentIndex < currentTestQuestions.length - 1) {
                currentIndex++;
                renderTestQuestion();
            }
        });
        
        document.getElementById('submitTestBtn').addEventListener('click', submitTest);
        
        document.getElementById('backToBankBtn').addEventListener('click', () => {
            testView.classList.add('hidden');
            bankView.classList.remove('hidden');
            tabBank.click();
            clearInterval(timerInterval);
        });
    };
</script>
</body>
</html>
